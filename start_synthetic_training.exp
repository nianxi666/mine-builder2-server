#!/usr/bin/expect -f
# ä¸€é”®å¯åŠ¨åˆæˆæ•°æ®è®­ç»ƒ

set timeout 600

spawn ssh -p 30022 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root4563@root@ssh-06aace8d2b864475e7b3e2eb54a8107e.zlrast8j3bxb@direct.virtaicloud.com

expect "password:"
send "liu20062020\r"

expect "#"
send "echo '=========================================='\r"
expect "#"
send "echo 'ğŸš€ å¯åŠ¨åˆæˆæ•°æ®è®­ç»ƒæµç¨‹'\r"
expect "#"
send "echo '=========================================='\r"
expect "#"
send "echo ''\r"
expect "#"

send "cd /gemini/code/upload_package\r"
expect "#"

send "echo 'ğŸ“Š æ­¥éª¤1: ç”Ÿæˆåˆæˆæ•°æ®ï¼ˆ200ä¸ªæ ·æœ¬ï¼‰...'\r"
expect "#"

send "python3 create_synthetic_dataset.py --num-samples 200 --output-dir /gemini/code/dataset_synthetic\r"
expect {
    "Generated" {
        exp_continue
    }
    "samples" {
        send "echo 'âœ… æ•°æ®ç”Ÿæˆå®Œæˆ'\r"
    }
    timeout {
        send "echo 'âš ï¸  è¶…æ—¶'\r"
    }
}
expect "#"

send "echo ''\r"
send "echo 'ğŸ“ˆ æ•°æ®ç»Ÿè®¡:'\r"
expect "#"

send "ls -d /gemini/code/dataset_synthetic/sample_* | wc -l\r"
expect "#"

send "echo ''\r"
send "echo 'ğŸ‹ï¸  æ­¥éª¤2: å¯åŠ¨è®­ç»ƒï¼ˆåœ¨screenä¸­ï¼‰...'\r"
expect "#"

send "screen -dmS training bash -c '\r"
send "python3 train_with_inference.py \\\\\r"
send "  --dataset-dir /gemini/code/dataset_synthetic \\\\\r"
send "  --output-dir /gemini/code/outputs_synthetic \\\\\r"
send "  --model-size small \\\\\r"
send "  --batch-size 8 \\\\\r"
send "  --epochs 100 \\\\\r"
send "  --lr 1e-4 \\\\\r"
send "  --use-amp \\\\\r"
send "  --save-every 50 \\\\\r"
send "  --inference-every 10 \\\\\r"
send "  --inference-samples 2 \\\\\r"
send "  --inference-steps 50 \\\\\r"
send "  --num-workers 4 \\\\\r"
send "  2>&1 | tee /gemini/code/training_synthetic.log'\r"
expect "#"

send "sleep 3\r"
expect "#"

send "echo 'âœ… è®­ç»ƒå·²å¯åŠ¨'\r"
expect "#"

send "echo ''\r"
send "screen -ls\r"
expect "#"

send "echo ''\r"
send "echo 'â° ç­‰å¾…10ç§’åæ£€æŸ¥è®­ç»ƒçŠ¶æ€...'\r"
expect "#"

send "sleep 10\r"
expect "#"

send "tail -20 /gemini/code/training_synthetic.log\r"
expect "#"

send "echo ''\r"
send "echo '=========================================='\r"
expect "#"
send "echo 'âœ… å¯åŠ¨å®Œæˆï¼'\r"
expect "#"
send "echo ''\r"
expect "#"
send "echo 'ç›‘æ§å‘½ä»¤:'\r"
expect "#"
send "echo '  screen -r training    # æŸ¥çœ‹è®­ç»ƒ'\r"
expect "#"
send "echo '  tail -f /gemini/code/training_synthetic.log'\r"
expect "#"
send "echo ''\r"
expect "#"
send "echo 'é¢„è®¡æ—¶é—´: 2-4å°æ—¶'\r"
expect "#"
send "echo '=========================================='\r"
expect "#"

send "exit\r"
expect eof
